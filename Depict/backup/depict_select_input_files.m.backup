function depict_select_input_files(varargin)

global st
global defaults
global The_files_to_cluster

gctrl=0;

function buttonCallback(varargin)
  uiresume(gcbf);
  gctrl=0;
  The_files_to_cluster=[];
end


while(gctrl==0)


  if(isempty(The_files_to_cluster)) 
    
  %try
  %    The_files_to_cluster.mat;
  %    if isnan(The_files_to_cluster.mat)
  %        files_to_cluster = spm_select(Inf,'any','Select files to cluster',[],pwd,'.*.nii$');
  %    end
  %catch

  ctrl=0;

  prompt_select='Select files to cluster';

  count=0;

  while(ctrl==0 && count < 2)

     count=count+1;

     file_names_cell=spm_select(Inf,'any',prompt_select,[],pwd,'.*.nii$');
     if(isempty(file_names_cell)==1) 
         strerr=strcat('You did not select any file. Please Select 4D image or at least six 3D images');
         herror1 = errordlg(strerr,'error1');
         uiwait(herror1); 
         continue; 
     end
 
     file_names=cellstr(file_names_cell);

     ctrl2=1;
     for ii=1:size(file_names)
        [tok,rem]=strtok(file_names{ii},'.');
        if(strcmp(rem,'.nii')==0) 
           strerr=strcat('You selected a file which is not NIfTI. Please Select 4D NIfTI or at least six 3D NIfTI');
           herror1 = errordlg(strerr,'error1');
           uiwait(herror1); 
           ctrl2=0; 
        end
     end
 
     if(ctrl2==0) 
        continue; 
     end

     if(size(file_names,1)==1)
          files_to_cluster=spm_vol(file_names{1})
          if(size(files_to_cluster,1)<2)
            strerr=strcat('The file you chose is a 3D NIfTI. Please Select 4D NIfTI or at least six 3D NIfTI');
            herror1 = errordlg(strerr,'error1');
            uiwait(herror1); 
          elseif(size(files_to_cluster,1)<6)
            strerr=strcat('The file you chose is a 4D NIfTI with only  ', num2str(size(files_to_cluster,1)),' images. Please select a NIfTI with at least 6 images');
            herror1 = errordlg(strerr,'error1');
            uiwait(herror1); 
          else
             ctrl2=1;
             for ii=1:size(files_to_cluster,1)
                file_to_cluster=files_to_cluster(ii);
                if(strcmp(file_to_cluster.descrip, '4D image')==0)
                   ctrl2=0;
                   break;
                end
             end
             if(ctrl2==1)        
                ctrl=1;
             else
               strerr=strcat('The file you chose does not have the correct format. Please select a NIfTI with at least 6 images');
               herror1 = errordlg(strerr,'error1');
               uiwait(herror1); 
             end
          end 
     elseif(size(file_names,1)>1 && size(file_names,1)<6)
          strerr=strcat('You chose a list of  ', num2str(size(file_names,1)),' NIfTi files. Please select at least six (3D) NIfTI files');
          herror1 = errordlg(strerr,'error1');
          uiwait(herror1); 
     else
          ctrl2=1;
          for ii=1:size(file_names,1)
              file_to_cluster=spm_vol(file_names{ii});
              if(size(file_to_cluster,1)>1)
                  strerr=strcat('The list you chose includes at least one 4D NIfTi file. Please Select a single 4D NIfTI or at least six 3D NIfTI');
                  herror1 = errordlg(strerr,'error1');
                  uiwait(herror1); 
                  ctrl2=0; 
                  break;
              end
          end
          if(ctrl2==1) 
             ctrl=1;
             files_to_cluster=spm_vol(file_names_cell);  
          %else
          %   prompt_select='Please Select 4D image or at least six 3D images'  
          end
      end

  end

  end % end ifisempty

  %files_to_cluster

  try, The_files_to_cluster=files_to_cluster; end

  gctrl=1;

  file_names=The_files_to_cluster.fname

  fgFiles = depict_figure('CreateWin','SelectedFiles','List of selected files');

  lstselui=uicontrol(fgFiles,'Style','ListBox','String',file_names,'Units', 'normalized','Position',[.05 .05 .9 .8],'FontSize',spm('FontSizes',12),'Max',100,'Min',1,'Value',[1:size(file_names,1)]);

  okbutton=uicontrol(fgFiles,'Style','PushButton','Units','normalized','Position',[.05 0.02 .45 0.055],'Callback','uiresume(gcbf)','String','ok','FontSize',spm('FontSizes',12));

  changebutton=uicontrol(fgFiles,'Style','PushButton','Units','normalized','Position',[.5 0.02 .45 0.055],'Callback',@buttonCallback,'String','Change files','FontSize',spm('FontSizes',12));

  %okbutton = uicontrol(fgSel,'Position',[315,50,70,25],'String','Ok','Callback','uiresume(gcbf)');

  uiwait(gcf);

%  changefiles=get(changebutton,'Value')

%  if(changefiles==1)
%    gctrl=0
%  end

  close(fgFiles);


end % end gctrl



end % end function



